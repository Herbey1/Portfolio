const translations = {
  es: {
    name: "Carlos Herbey GÃ¡mez Gaxiola",
    role: "Estudiante de IngenierÃ­a de Software y TecnologÃ­as Emergentes",
    tagline: "Explorando el desarrollo frontend y soÃ±ando con bases de datos y ciberseguridad",
    nav: { cv: "CV", projects: "Proyectos", about: "Sobre mÃ­", contact: "Contacto" },
    sections: { cv: "CV", projects: "Proyectos", about: "Sobre mÃ­", contact: "Contacto" },
    bio:
      "Soy estudiante de la Universidad AutÃ³noma de Baja California en la Facultad de Ciencias QuÃ­micas e IngenierÃ­a. Me apasiona la programaciÃ³n, especialmente el desarrollo frontend, aunque tambiÃ©n me interesa aprender mÃ¡s sobre bases de datos y ciberseguridad. Me gusta probar cosas nuevas, practicar voleibol y, en mis ratos libres, disfruto dibujar y pintar.",
    projects: {
      sgca: {
        title: "Sistema de GestiÃ³n de Comisiones AcadÃ©micas (SGCA â€“ UABC)",
        desc: "AplicaciÃ³n para automatizar y optimizar comisiones acadÃ©micas en FCQI UABC.",
      },
      ecogestor: {
        title: "EcoGestor",
        desc: "Plataforma web para gestiÃ³n ambiental con sensores IoT.",
      },
      memoria: {
        title: "Memoria Familiar (en desarrollo)",
        desc: "App de IA para preservar historias de vida familiares.",
      },
      playlist: {
        title: "Playlist Royale",
        desc: "App de mÃºsica social con recompensas y propinas.",
      },
    },
    labels: { live: "Live", in_progress: "En desarrollo", private: "Repositorio privado" },
    credits: "DiseÃ±o pastel con acento naranja. Dark mode por defecto.",
    cv: {
      download: "Descargar PDF",
      back: "Volver",
      summary: "Resumen",
      skills: "TecnologÃ­as",
      education: "EducaciÃ³n",
      edu_univ_degree: "IngenierÃ­a de Software y TecnologÃ­as Emergentes",
      edu_univ_school: "Universidad AutÃ³noma de Baja California â€” FCQI",
      edu_univ_dates: "Ago 2021 â€” Presente",
      edu_univ_semester: "Semestre: 8Âº",
      edu_univ_gpa: "Promedio: 87.25",
      edu_univ_grad: "GraduaciÃ³n esperada: Junio 2026",
      personal: "Datos personales",
      personal_residence_label: "Residencia:",
      personal_residence: "Tijuana, Baja California, MÃ©xico",
      personal_birthplace_label: "Lugar de nacimiento:",
      personal_birthplace: "Tijuana, Baja California, MÃ©xico",
      personal_age_label: "Edad:",
      personal_age_value: "22 aÃ±os",
      personal_dob_label: "Fecha de nacimiento:",
      personal_dob: "13 de enero de 2003",
      edu_hs_school: "Centro de Bachillerato TecnolÃ³gico Industrial y de Servicios No. 116",
      edu_hs_specialty: "Especialidad: Mantenimiento Industrial",
      edu_hs_dates: "2018 â€” 2021",
      projects: "Proyectos seleccionados",
      skill_languages: "Lenguajes",
      skill_frontend: "Frontend",
      skill_backend: "Backend",
      skill_db: "Bases de datos",
      skill_systems: "Sistemas y redes",
      skill_office: "OfimÃ¡tica",
      skill_foundations: "Fundamentos",
      list_languages: "Lenguaje C, Java, JavaScript, Python, Lenguaje ensamblador (bÃ¡sico)",
      list_frontend: "HTML, CSS, React",
      list_backend: "Node.js, Java",
      list_db: "MySQL",
      list_systems: "Windows, Linux (bÃ¡sico), Redes (bÃ¡sico)",
      list_office: "Excel, Word",
      list_foundations: "POO, Requerimientos, DocumentaciÃ³n, AdministraciÃ³n de proyectos de software, Aplicaciones web, CÃ³mputo en la nube, Emprendimiento de negocios de software, Seguridad de software, MatemÃ¡ticas discretas, EstadÃ­stica avanzada, Algoritmos, Inteligencia artificial, Traductores en Java, Conocimientos bÃ¡sicos de electrÃ³nica (CBTIS 116)",
      sgca_1: "Automatiza solicitudes, aprobaciones y reportes con evidencias.",
      sgca_2: "Prototipo acadÃ©mico en Java/Swing con MySQL y UML.",
      eco_1: "Plataforma web para gestiÃ³n ambiental (monitoreo de residuos y participaciÃ³n ciudadana).",
      eco_2: "Monitoreo de residuos, gateway de comunicaciÃ³n y app para ciudadanos.",
      mem_1: "App de IA para entrevistar y preservar historias de vida.",
      play_1: "MÃºsica social con propinas y recompensas; integra Spotify/YouTube APIs.",
      toast_label: "CV",
      toast_open: "Abrir CV",
      toast_pin: "Fijar",
      toast_unpin: "Desfijar",
    },
  },
  en: {
    name: "Carlos Herbey GÃ¡mez Gaxiola",
    role: "Software Engineering and Emerging Technologies student",
    tagline: "Exploring frontend while dreaming of databases and cybersecurity",
    nav: { cv: "Resume", projects: "Projects", about: "About", contact: "Contact" },
    sections: { cv: "Resume", projects: "Projects", about: "About", contact: "Contact" },
    bio:
      "I study at the Autonomous University of Baja California (FCQI). I'm passionate about programmingâ€”especially frontend developmentâ€”and Iâ€™m also eager to learn more about databases and cybersecurity. I enjoy trying new things, playing volleyball, and drawing and painting in my free time.",
    projects: {
      sgca: {
        title: "Academic Commissions Management System (SGCA â€“ UABC)",
        desc: "App to automate and streamline academic commission requests at FCQI UABC.",
      },
      ecogestor: {
        title: "EcoGestor",
        desc: "Web platform for environmental management with IoT sensors.",
      },
      memoria: {
        title: "Family Memory (in progress)",
        desc: "AI app to preserve life stories through friendly interviews.",
      },
      playlist: {
        title: "Playlist Royale",
        desc: "Social music app with rewards and tips.",
      },
    },
    labels: { live: "Live", in_progress: "In progress", private: "Private repository" },
    credits: "Pastel design with orange accent. Dark mode by default.",
    cv: {
      download: "Download PDF",
      back: "Back",
      summary: "Summary",
      skills: "Skills",
      education: "Education",
      edu_univ_degree: "Software Engineering and Emerging Technologies",
      edu_univ_school: "Autonomous University of Baja California â€” FCQI",
      edu_univ_dates: "Aug 2021 â€” Present",
      edu_univ_semester: "Semester: 8th",
      edu_univ_gpa: "GPA: 87.25",
      edu_univ_grad: "Expected graduation: June 2026",
      personal: "Personal details",
      personal_residence_label: "Residence:",
      personal_residence: "Tijuana, Baja California, Mexico",
      personal_birthplace_label: "Place of birth:",
      personal_birthplace: "Tijuana, Baja California, Mexico",
      personal_age_label: "Age:",
      personal_age_value: "22",
      personal_dob_label: "Date of birth:",
      personal_dob: "January 13, 2003",
      edu_hs_school: "CBTIS No. 116",
      edu_hs_specialty: "Specialty: Industrial Maintenance",
      edu_hs_dates: "2018 â€” 2021",
      projects: "Selected Projects",
      skill_languages: "Languages",
      skill_frontend: "Frontend",
      skill_backend: "Backend",
      skill_db: "Databases",
      skill_systems: "Systems & Networks",
      skill_office: "Office",
      skill_foundations: "Foundations",
      list_languages: "C, Java, JavaScript, Python, Assembly language (basic)",
      list_frontend: "HTML, CSS, React",
      list_backend: "Node.js, Java",
      list_db: "MySQL",
      list_systems: "Windows, Linux (basic), Networking (basic)",
      list_office: "Excel, Word",
      list_foundations: "OOP, Requirements, Documentation, Software project management, Web applications, Cloud computing, Software business entrepreneurship, Software security, Discrete mathematics, Advanced statistics, Algorithms, Artificial intelligence, Compilers in Java, Basic electronics (CBTIS 116)",
      sgca_1: "Automates requests, approvals and reporting with evidence.",
      sgca_2: "Academic prototype in Java/Swing with MySQL and UML.",
      eco_1: "Web platform for environmental management (waste monitoring and citizen participation).",
      eco_2: "Waste monitoring, comms gateway and a citizen app.",
      mem_1: "AI app to interview and preserve life stories.",
      play_1: "Social music app with tips and rewards; Spotify/YouTube APIs.",
      toast_label: "Resume",
      toast_open: "Open Resume",
      toast_pin: "Pin",
      toast_unpin: "Unpin",
    },
  },
};

function setTheme(theme) {
  const root = document.documentElement;
  root.setAttribute("data-theme", theme);
  localStorage.setItem("theme", theme);
  const themeBtn = document.getElementById("theme-toggle");
  if (themeBtn) {
    themeBtn.textContent = theme === "dark" ? "ðŸŒ™" : "â˜€ï¸";
    themeBtn.setAttribute("aria-label", theme === "dark" ? "Cambiar a claro" : "Cambiar a oscuro");
  }
}

function initTheme() {
  const stored = localStorage.getItem("theme");
  if (stored) return setTheme(stored);
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  setTheme(prefersDark ? "dark" : "dark"); // dark por defecto
}

function setLang(lang) {
  const t = translations[lang] || translations.es;
  document.documentElement.lang = lang;
  localStorage.setItem("lang", lang);
  const langBtn = document.getElementById("lang-toggle");
  if (langBtn) langBtn.textContent = lang.toUpperCase();
  // text nodes
  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.getAttribute("data-i18n");
    const value = key.split(".").reduce((acc, k) => (acc ? acc[k] : undefined), t);
    if (typeof value === "string") {
      el.textContent = value;
    }
  });
  // update toast texts
  updateCvToastTexts();
}

function initLang() {
  const stored = localStorage.getItem("lang") || "es";
  setLang(stored);
}

document.addEventListener("DOMContentLoaded", () => {
  // Year
  const y = document.getElementById("year");
  if (y) y.textContent = new Date().getFullYear();

  // Theme
  initTheme();
  // Ajustar altura de barra de header a ancho completo
  function setHeaderBarHeight() {
    const header = document.querySelector('.header');
    if (!header) return;
    const h = Math.ceil(header.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--header-bar-h', h + 'px');
  }
  setHeaderBarHeight();
  window.addEventListener('resize', () => requestAnimationFrame(() => {
    setHeaderBarHeight();
    const toast = document.getElementById('cv-toast');
    if (toast) { setCvToastRestWidth(toast); setCvToastHoverWidth(toast); }
  }));
  const themeToggle = document.getElementById("theme-toggle");
  if (themeToggle) {
    themeToggle.addEventListener("click", () => {
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      setTheme(isDark ? "light" : "dark");
      requestAnimationFrame(setHeaderBarHeight);
    });
  }

  // Lang
  initLang();
  const langToggle = document.getElementById("lang-toggle");
  if (langToggle) {
    langToggle.addEventListener("click", () => {
      const current = localStorage.getItem("lang") || "es";
      setLang(current === "es" ? "en" : "es");
      requestAnimationFrame(setHeaderBarHeight);
    });
  }

  // CV download to PDF via print
  const cvBtn = document.getElementById('cv-download');
  if (cvBtn) {
    cvBtn.addEventListener('click', () => {
      setHeaderBarHeight();
      window.print();
    });
  }

  // Carousels
  const carousels = Array.from(document.querySelectorAll('.carousel'));
  carousels.forEach((c, idx) => {
    try {
      const list = JSON.parse(c.getAttribute('data-images') || '[]');
      const altPrefix = c.getAttribute('data-alt') || 'Imagen';
      if (!Array.isArray(list) || list.length === 0) return;

      c.dataset.index = '0';
      const img = document.createElement('img');
      img.className = 'cover';
      img.decoding = 'async';
      img.loading = 'lazy';

      const btnPrev = document.createElement('button');
      btnPrev.className = 'nav-btn nav-prev';
      btnPrev.type = 'button';
      btnPrev.setAttribute('aria-label', 'Anterior');
      btnPrev.textContent = 'â€¹';

      const btnNext = document.createElement('button');
      btnNext.className = 'nav-btn nav-next';
      btnNext.type = 'button';
      btnNext.setAttribute('aria-label', 'Siguiente');
      btnNext.textContent = 'â€º';

      function render(i) {
        const n = list.length;
        const j = ((i % n) + n) % n;
        c.dataset.index = String(j);
        img.style.opacity = '0';
        const next = list[j];
        const onload = () => {
          requestAnimationFrame(() => { img.style.opacity = '1'; });
          img.removeEventListener('load', onload);
        };
        img.addEventListener('load', onload);
        img.src = next;
        img.alt = `${altPrefix} (${j + 1}/${n})`;
      }

      let timer = null;
      const intervalMs = parseInt(c.getAttribute('data-interval') || '4000', 10);
      const hasMultiple = list.length > 1;

      function clearTimer() { if (timer) { clearInterval(timer); timer = null; } }
      function startTimer() { if (hasMultiple && !timer) { timer = setInterval(() => btnNext.click(), intervalMs); } }

      btnPrev.addEventListener('click', () => {
        const i = Number(c.dataset.index || '0') - 1;
        render(i);
        clearTimer(); startTimer();
      });
      btnNext.addEventListener('click', () => {
        const i = Number(c.dataset.index || '0') + 1;
        render(i);
        clearTimer(); startTimer();
      });

      // Keyboard support when focused
      c.tabIndex = 0;
      c.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') { btnPrev.click(); }
        if (e.key === 'ArrowRight') { btnNext.click(); }
      });

      img.style.opacity = '0';
      c.appendChild(img);
      if (hasMultiple) {
        c.appendChild(btnPrev);
        c.appendChild(btnNext);
      }
      render(0);
      if (img.complete) { img.style.opacity = '1'; }

      // Autoplay + pause on hover
      c.addEventListener('mouseenter', clearTimer);
      c.addEventListener('mouseleave', startTimer);

      // Pause when not visible
      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries) => {
          entries.forEach(e => {
            if (e.isIntersecting) startTimer(); else clearTimer();
          });
        }, { threshold: 0.25 });
        io.observe(c);
      } else {
        startTimer();
      }
    } catch (err) {
      console.warn('Carousel setup failed:', err);
    }
  });
  // CV toast
  initCvToast();
  // Smooth anchors
  initSmoothAnchors();
  // Mobile nav
  initMobileNav();
});

function initMobileNav() {
  const toggle = document.getElementById('nav-toggle');
  const nav = document.getElementById('nav-menu');
  if (!toggle || !nav) return;
  const close = () => {
    nav.setAttribute('data-open', 'false');
    toggle.setAttribute('aria-expanded', 'false');
  };
  const open = () => {
    nav.setAttribute('data-open', 'true');
    toggle.setAttribute('aria-expanded', 'true');
  };
  toggle.addEventListener('click', () => {
    const opened = nav.getAttribute('data-open') === 'true';
    opened ? close() : open();
  });
  // Close on outside click
  document.addEventListener('click', (e) => {
    if (e.target === toggle) return;
    if (nav.getAttribute('data-open') !== 'true') return;
    if (!nav.contains(e.target)) close();
  });
  // Close when clicking a link
  nav.querySelectorAll('a[href^="#"]').forEach(a => a.addEventListener('click', () => close()));
}

function initCvToast() {
  // Do not render toast on the CV page
  if (/cv\.html$/i.test(location.pathname)) return;
  if (document.getElementById('cv-toast')) return;
  const t = translations[localStorage.getItem('lang') || 'es'] || translations.es;
  const wrap = document.createElement('div');
  wrap.id = 'cv-toast';
  wrap.className = 'cv-toast';
  wrap.tabIndex = 0;
  wrap.setAttribute('role', 'region');
  wrap.setAttribute('aria-label', t.cv.toast_label || 'CV');
  wrap.innerHTML = `
    <span class=\"label\" data-i18n=\"cv.toast_label\">${t.cv.toast_label || 'CV'}</span>
    <span class=\"actions\">
      <a class=\"btn small\" href=\"cv.html\" data-i18n=\"cv.toast_open\">${t.cv.toast_open || 'Open Resume'}</a>
    </span>
  `;
  document.body.appendChild(wrap);
  // Set base width (Resume) and hover width (button)
  const applyWidth = () => { setCvToastRestWidth(wrap); setCvToastHoverWidth(wrap); };
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(applyWidth);
  } else {
    setTimeout(applyWidth, 0);
  }
}

function updateCvToastTexts() {
  const wrap = document.getElementById('cv-toast');
  if (!wrap) return;
  const t = translations[localStorage.getItem('lang') || 'es'] || translations.es;
  const label = wrap.querySelector('.label');
  const link = wrap.querySelector('a');
  if (label) label.textContent = t.cv.toast_label || 'CV';
  if (link) link.textContent = t.cv.toast_open || 'Open Resume';
  setCvToastRestWidth(wrap);
  setCvToastHoverWidth(wrap);
}

function setCvToastRestWidth(wrap) {
  try {
    const text = (translations.en && translations.en.cv && translations.en.cv.toast_label) || 'Resume';
    const meas = document.createElement('span');
    const label = wrap.querySelector('.label');
    const csLabel = label ? getComputedStyle(label) : getComputedStyle(wrap);
    const csWrap = getComputedStyle(wrap);
    meas.textContent = text;
    meas.style.position = 'absolute';
    meas.style.visibility = 'hidden';
    meas.style.whiteSpace = 'nowrap';
    meas.style.fontWeight = csLabel.fontWeight || '700';
    meas.style.fontSize = csLabel.fontSize || '16px';
    meas.style.fontFamily = csLabel.fontFamily || getComputedStyle(document.body).fontFamily;
    document.body.appendChild(meas);
    const textW = Math.ceil(meas.getBoundingClientRect().width);
    document.body.removeChild(meas);
    const pl = parseFloat(csWrap.paddingLeft) || 0;
    const pr = parseFloat(csWrap.paddingRight) || 0;
    const base = textW + pl + pr + 8; // include padding + buffer
    wrap.style.setProperty('--cv-toast-rest', Math.ceil(base) + 'px');
  } catch (e) {
    // ignore
  }
}

function setCvToastHoverWidth(wrap) {
  try {
    const actions = wrap.querySelector('.actions');
    const link = actions?.querySelector('a');
    if (!actions || !link) return;
    const csWrap = getComputedStyle(wrap);
    const prev = { maxWidth: actions.style.maxWidth, opacity: actions.style.opacity, transform: actions.style.transform, marginLeft: actions.style.marginLeft };
    actions.style.maxWidth = 'none';
    actions.style.opacity = '0';
    actions.style.transform = 'none';
    actions.style.marginLeft = '6px';
    // prevent wrapping for measure
    const prevWs = link.style.whiteSpace;
    link.style.whiteSpace = 'nowrap';
    const w = Math.ceil(actions.getBoundingClientRect().width) + 14; // include left margin + buffer
    // restore
    actions.style.maxWidth = prev.maxWidth;
    actions.style.opacity = prev.opacity;
    actions.style.transform = prev.transform;
    actions.style.marginLeft = prev.marginLeft;
    link.style.whiteSpace = prevWs;
    const pl = parseFloat(csWrap.paddingLeft) || 0;
    const pr = parseFloat(csWrap.paddingRight) || 0;
    const full = Math.ceil(pl + pr + Math.max(110, w));
    wrap.style.setProperty('--cv-actions-w', Math.max(110, w) + 'px');
    wrap.style.setProperty('--cv-toast-hover', full + 'px');
  } catch (_) {}
}

function initSmoothAnchors() {
  document.addEventListener('click', (e) => {
    const a = e.target.closest('a[href^="#"]');
    if (!a) return;
    const href = a.getAttribute('href');
    if (!href) return;
    // ignore empty hash links not intended for scrolling
    if (href === '#') {
      e.preventDefault();
      smoothScrollTo(0, 500);
      return;
    }
    const id = href.slice(1);
    const el = document.getElementById(id);
    if (!el) return;
    e.preventDefault();
    const headerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-bar-h')) || 0;
    const y = el.getBoundingClientRect().top + window.scrollY - headerH - 10;
    smoothScrollTo(y, 500);
  });
}

function smoothScrollTo(targetY, duration = 500) {
  const startY = window.scrollY || window.pageYOffset;
  const diff = targetY - startY;
  const start = performance.now();
  const ease = (t) => (t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2);

  function step(now) {
    const elapsed = now - start;
    const t = Math.min(1, elapsed / duration);
    const eased = ease(t);
    window.scrollTo(0, startY + diff * eased);
    if (elapsed < duration) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
